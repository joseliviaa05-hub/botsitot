const { Client, LocalAuth } = require('whatsapp-web.js');
const qrcode = require('qrcode-terminal');
const express = require('express');
const fs = require('fs');

// Servidor Express
const app = express();
app.get('/', (req, res) => res.send('ğŸ¤– Bot activo!'));
app.get('/health', (req, res) => res.json({ status: 'ok' }));
app.get('/stats', (req, res) => {
    const clientes = JSON.parse(fs.readFileSync('./data/clientes.json', 'utf8'));
    res.json(clientes.estadisticas);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“Š API PARA EL DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Habilitar CORS para el dashboard
app.use((req, res, next) => {
    res.header('Access-Control-Allow-Origin', '*');
    res.header('Access-Control-Allow-Headers', 'Origin, X-Requested-With, Content-Type, Accept');
    next();
});

// Obtener todos los pedidos
app.get('/api/pedidos', (req, res) => {
    try {
        const pedidos = JSON.parse(fs.readFileSync('./data/pedidos.json', 'utf8'));
        res.json(pedidos.pedidos);
    } catch (error) {
        res.status(500).json({ error: 'Error al cargar pedidos' });
    }
});

// Obtener un pedido especÃ­fico
app.get('/api/pedidos/:id', (req, res) => {
    try {
        const pedidos = JSON.parse(fs.readFileSync('./data/pedidos.json', 'utf8'));
        const pedido = pedidos.pedidos.find(p => p.id === req.params.id);
        
        if (pedido) {
            res.json(pedido);
        } else {
            res.status(404).json({ error: 'Pedido no encontrado' });
        }
    } catch (error) {
        res.status(500).json({ error: 'Error al cargar pedido' });
    }
});

// Obtener todos los clientes
app.get('/api/clientes', (req, res) => {
    try {
        const clientes = JSON.parse(fs.readFileSync('./data/clientes.json', 'utf8'));
        res.json(clientes.clientes);
    } catch (error) {
        res.status(500).json({ error: 'Error al cargar clientes' });
    }
});

// Obtener un cliente especÃ­fico
app.get('/api/clientes/:telefono', (req, res) => {
    try {
        const clientes = JSON.parse(fs.readFileSync('./data/clientes.json', 'utf8'));
        const cliente = clientes.clientes.find(c => c.telefono === req.params.telefono);
        
        if (cliente) {
            res.json(cliente);
        } else {
            res.status(404).json({ error: 'Cliente no encontrado' });
        }
    } catch (error) {
        res.status(500).json({ error: 'Error al cargar cliente' });
    }
});

// Obtener productos
app.get('/api/productos', (req, res) => {
    try {
        const productos = JSON.parse(fs.readFileSync('./data/lista-precios.json', 'utf8'));
        res.json(productos);
    } catch (error) {
        res.status(500).json({ error: 'Error al cargar productos' });
    }
});

// Obtener estadÃ­sticas completas
app.get('/api/estadisticas', (req, res) => {
    try {
        const clientes = JSON.parse(fs.readFileSync('./data/clientes.json', 'utf8'));
        const pedidos = JSON.parse(fs.readFileSync('./data/pedidos.json', 'utf8'));
        
        // Calcular pedidos por dÃ­a (Ãºltimos 7 dÃ­as)
        const hoy = new Date();
        const pedidosPorDia = [];
        
        for (let i = 6; i >= 0; i--) {
            const fecha = new Date(hoy);
            fecha.setDate(fecha.getDate() - i);
            const fechaStr = fecha.toISOString().split('T')[0];
            
            const pedidosDia = pedidos.pedidos.filter(p => {
                const pedidoFecha = new Date(p.fecha).toISOString().split('T')[0];
                return pedidoFecha === fechaStr;
            });
            
            const totalDia = pedidosDia.reduce((sum, p) => sum + p.total, 0);
            
            pedidosPorDia.push({
                fecha: fechaStr,
                pedidos: pedidosDia.length,
                ventas: totalDia
            });
        }
        
        res.json({
            ...clientes.estadisticas,
            pedidos_por_dia: pedidosPorDia,
            ultimo_pedido: pedidos.pedidos[pedidos.pedidos.length - 1] || null
        });
    } catch (error) {
        res.status(500).json({ error: 'Error al cargar estadÃ­sticas' });
    }
});

// Estado del bot
app.get('/api/estado', (req, res) => {
    res.json({
        activo: client.info ? true : false,
        conectado: client.info ? true : false,
        numero: client.info ? client.info.wid.user : null,
        notificaciones: negocioData.notificaciones_activas,
        respuestas_automaticas: negocioData.respuestas_automaticas_activas
    });
});

// Cambiar estado de respuestas automÃ¡ticas
app.post('/api/toggle-respuestas', express.json(), (req, res) => {
    try {
        negocioData.respuestas_automaticas_activas = !negocioData.respuestas_automaticas_activas;
        fs.writeFileSync('./data/negocio.json', JSON.stringify(negocioData, null, 2));
        
        console.log(`ğŸ”„ Respuestas automÃ¡ticas ${negocioData.respuestas_automaticas_activas ? 'ACTIVADAS' : 'PAUSADAS'} desde el dashboard`);
        
        res.json({
            success: true,
            estado: negocioData.respuestas_automaticas_activas
        });
    } catch (error) {
        res.status(500).json({ error: 'Error al cambiar estado' });
    }
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`âœ… Servidor en puerto ${PORT}`));

// Cargar datos
const negocioData = JSON.parse(fs.readFileSync('./data/negocio.json', 'utf8'));
const listaPrecios = JSON.parse(fs.readFileSync('./data/lista-precios.json', 'utf8'));
const contactosIgnorar = JSON.parse(fs.readFileSync('./data/contactos-ignorar.json', 'utf8'));
const palabrasClave = JSON.parse(fs.readFileSync('./data/palabras-clave.json', 'utf8'));
const configPedidos = JSON.parse(fs.readFileSync('./data/config-pedidos.json', 'utf8'));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ§  SISTEMA DE MEMORIA DE CONVERSACIONES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Almacenar sesiones activas (clientes en medio de una conversaciÃ³n)
const sesionesActivas = new Map();

// Tiempo de expiraciÃ³n de sesiÃ³n (10 minutos)
const TIEMPO_EXPIRACION_SESION = 10 * 60 * 1000; // 10 minutos en milisegundos

// FunciÃ³n para marcar que un cliente tiene una conversaciÃ³n activa
function marcarSesionActiva(from, tipo = 'conversacion') {
    sesionesActivas.set(from, {
        tipo: tipo,
        timestamp: Date.now()
    });
    
    // Auto-limpiar despuÃ©s del tiempo de expiraciÃ³n
    setTimeout(() => {
        if (sesionesActivas.has(from)) {
            const sesion = sesionesActivas.get(from);
            if (Date.now() - sesion.timestamp >= TIEMPO_EXPIRACION_SESION) {
                sesionesActivas.delete(from);
                console.log(`ğŸ• SesiÃ³n expirada para: ${from}`);
            }
        }
    }, TIEMPO_EXPIRACION_SESION);
}

// FunciÃ³n para verificar si un cliente tiene sesiÃ³n activa
function tieneSesionActiva(from) {
    if (!sesionesActivas.has(from)) return false;
    
    const sesion = sesionesActivas.get(from);
    const tiempoTranscurrido = Date.now() - sesion.timestamp;
    
    // Si pasaron mÃ¡s de 10 minutos, eliminar sesiÃ³n
    if (tiempoTranscurrido >= TIEMPO_EXPIRACION_SESION) {
        sesionesActivas.delete(from);
        return false;
    }
    
    return true;
}

// FunciÃ³n para limpiar sesiÃ³n
function limpiarSesion(from) {
    sesionesActivas.delete(from);
}

// Carritos temporales en memoria
const carritos = {};
const timersCarrito = {};

// Cliente de WhatsApp
const client = new Client({
    authStrategy: new LocalAuth(),
    puppeteer: {
        headless: true,
        args: ['--no-sandbox', '--disable-setuid-sandbox']
    }
});

console.log('\nğŸš€ğŸš€ğŸš€ INICIANDO BOT DE WHATSAPP ğŸš€ğŸš€ğŸš€\n');

client.on('qr', (qr) => {
    console.log('\n==============================================');
    console.log('ğŸ“± Â¡ESCANEA ESTE CÃ“DIGO QR!');
    console.log('==============================================\n');
    qrcode.generate(qr, { small: true });
    console.log('\n==============================================');
    console.log('ğŸ‘† Abre WhatsApp en tu celular');
    console.log('ğŸ‘‰ MenÃº â†’ Dispositivos vinculados');
    console.log('ğŸ‘‰ Vincular un dispositivo');
    console.log('ğŸ‘‰ Escanea el QR de arriba');
    console.log('==============================================\n');
});

client.on('ready', () => {
    console.log('\nğŸ‰ğŸ‰ğŸ‰ Â¡BOT CONECTADO EXITOSAMENTE! ğŸ‰ğŸ‰ğŸ‰\n');
    console.log('ğŸ¤– Sistema de filtrado inteligente ACTIVADO');
    console.log('ğŸ§  Sistema de memoria de conversaciones ACTIVADO');
    console.log('ğŸ›’ Sistema de pedidos ACTIVADO');
    console.log('ğŸ‘¥ Sistema de gestiÃ³n de clientes ACTIVADO');
    console.log(`ğŸ“µ Contactos ignorados: ${contactosIgnorar.contactos_ignorar.length}`);
    
    const clientesData = JSON.parse(fs.readFileSync('./data/clientes.json', 'utf8'));
    console.log(`ğŸ‘¥ Clientes registrados: ${clientesData.estadisticas.total_clientes}`);
    console.log(`ğŸ“¦ Total pedidos: ${clientesData.estadisticas.total_pedidos}`);
    console.log(`ğŸ’° Total vendido: $${clientesData.estadisticas.total_vendido}\n`);
});

client.on('message', async (msg) => {
    const from = msg.from;
    const texto = msg.body;
    const textoLower = texto.toLowerCase();
    const contacto = await msg.getContact();
    const nombreContacto = contacto.pushname || contacto.name || contacto.number || from;
    
    console.log(`\nğŸ“¨ Mensaje recibido de: ${nombreContacto} (${from})`);
    console.log(`ğŸ’¬ Contenido: "${texto}"`);
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸš« FILTRO: SOLO CHATS INDIVIDUALES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Ignorar mensajes de grupos
    if (from.endsWith('@g.us')) {
        console.log(`ğŸš« IGNORADO: Mensaje de grupo`);
        console.log(`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`);
        return;
    }
    
    // Ignorar estados (status)
    if (from === 'status@broadcast') {
        console.log(`ğŸš« IGNORADO: Estado de WhatsApp`);
        console.log(`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`);
        return;
    }
    
    // Ignorar listas de difusiÃ³n
    if (from.endsWith('@broadcast')) {
        console.log(`ğŸš« IGNORADO: Lista de difusiÃ³n`);
        console.log(`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`);
        return;
    }
    
    // Solo procesar chats individuales (nÃºmeros que terminan en @c.us)
    if (!from.endsWith('@c.us')) {
        console.log(`ğŸš« IGNORADO: No es un chat individual`);
        console.log(`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`);
        return;
    }
    
    console.log(`âœ… CHAT INDIVIDUAL: Procesando mensaje`);
    
    // Registrar o actualizar cliente
    registrarOActualizarCliente(from, nombreContacto);
    
    // Comandos del dueÃ±o para controlar el bot (siempre funcionan)
    if (from === negocioData.numero_dueÃ±o) {
        
        // Pausar respuestas automÃ¡ticas
        if (textoLower.match(/pausar bot|pausar respuestas|apagar bot|desactivar bot/)) {
            negocioData.respuestas_automaticas_activas = false;
            fs.writeFileSync('./data/negocio.json', JSON.stringify(negocioData, null, 2));
            await msg.reply(`â¸ï¸ *RESPUESTAS AUTOMÃTICAS PAUSADAS*\n\n` +
                           `El bot NO responderÃ¡ a los clientes.\n` +
                           `TÃº puedes seguir controlÃ¡ndolo.\n\n` +
                           `Para reanudar: "reanudar bot"`);
            console.log(`â¸ï¸ Respuestas automÃ¡ticas PAUSADAS por el dueÃ±o`);
            return;
        }
        
        // Reanudar respuestas automÃ¡ticas
        if (textoLower.match(/reanudar bot|reanudar respuestas|activar bot|encender bot/)) {
            negocioData.respuestas_automaticas_activas = true;
            fs.writeFileSync('./data/negocio.json', JSON.stringify(negocioData, null, 2));
            await msg.reply(`â–¶ï¸ *RESPUESTAS AUTOMÃTICAS REACTIVADAS*\n\n` +
                           `El bot volverÃ¡ a responder a los clientes automÃ¡ticamente.\n\n` +
                           `Para pausar: "pausar bot"`);
            console.log(`â–¶ï¸ Respuestas automÃ¡ticas REACTIVADAS por el dueÃ±o`);
            return;
        }
        
        // Ver estado del bot
        if (textoLower.match(/estado del bot|estado bot|bot estado/)) {
            const estadoRespuestas = negocioData.respuestas_automaticas_activas ? 'â–¶ï¸ ACTIVAS' : 'â¸ï¸ PAUSADAS';
            const estadoNotificaciones = negocioData.notificaciones_activas ? 'âœ… ACTIVADAS' : 'ğŸ”• DESACTIVADAS';
            
            await msg.reply(`ğŸ¤– *ESTADO DEL BOT*\n\n` +
                           `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n` +
                           `ğŸ”„ Respuestas automÃ¡ticas: ${estadoRespuestas}\n` +
                           `ğŸ”” Notificaciones: ${estadoNotificaciones}\n` +
                           `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n` +
                           `*Comandos disponibles:*\n` +
                           `â€¢ "pausar bot" - Pausar respuestas\n` +
                           `â€¢ "reanudar bot" - Reanudar respuestas\n` +
                           `â€¢ "activar notificaciones"\n` +
                           `â€¢ "desactivar notificaciones"\n` +
                           `â€¢ "estadisticas"`);
            return;
        }
    }
    
    // Si las respuestas automÃ¡ticas estÃ¡n pausadas, NO procesar
    if (!negocioData.respuestas_automaticas_activas) {
        console.log(`â¸ï¸ IGNORADO: Respuestas automÃ¡ticas pausadas`);
        console.log(`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`);
        return;
    }
    
    // ğŸš« FILTRO 1: Lista negra
    if (contactosIgnorar.contactos_ignorar.includes(from)) {
        console.log(`ğŸš« IGNORADO: Contacto en lista negra`);
        console.log(`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`);
        return;
    }
    
    // ğŸ§  VERIFICAR SI TIENE SESIÃ“N ACTIVA (conversaciÃ³n en curso)
    const tieneSesion = tieneSesionActiva(from);
    
    // ğŸ” FILTRO 2: Detectar si es mensaje de negocio
    const esMensajeNegocio = verificarMensajeNegocio(textoLower);
    
    // Si NO es mensaje de negocio Y NO tiene sesiÃ³n activa, ignorar
    if (!esMensajeNegocio && !tieneSesion) {
        console.log(`ğŸ¤· IGNORADO: No contiene palabras de negocio/productos`);
        console.log(`ğŸ’¡ TIP: Mensaje parece personal o sin contexto comercial`);
        console.log(`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`);
        return;
    }
    
    // Si tiene sesiÃ³n activa, procesar aunque no tenga palabras clave
    if (tieneSesion) {
        console.log(`ğŸ§  PROCESANDO: Cliente con conversaciÃ³n activa`);
    } else {
        console.log(`âœ… PROCESANDO: Mensaje relacionado con negocio/productos`);
    }
    
    // Renovar sesiÃ³n activa
    marcarSesionActiva(from);
    
    try {
        const respuesta = await procesarMensaje(textoLower, texto, from, nombreContacto);
        await msg.reply(respuesta);
        console.log(`ğŸ“¤ Respuesta enviada correctamente`);
    } catch (error) {
        console.error(`âŒ Error al enviar respuesta:`, error);
    }
    
    console.log(`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`);
});

// ğŸ‘¥ Registrar o actualizar cliente
function registrarOActualizarCliente(telefono, nombre) {
    const clientesData = JSON.parse(fs.readFileSync('./data/clientes.json', 'utf8'));
    
    let cliente = clientesData.clientes.find(c => c.telefono === telefono);
    
    if (!cliente) {
        // Nuevo cliente
        cliente = {
            telefono: telefono,
            nombre: nombre,
            fecha_registro: new Date().toISOString(),
            ultima_interaccion: new Date().toISOString(),
            total_pedidos: 0,
            total_gastado: 0,
            pedidos: []
        };
        clientesData.clientes.push(cliente);
        clientesData.estadisticas.total_clientes += 1;
        
        console.log(`ğŸ‘¤ Nuevo cliente registrado: ${nombre} (${telefono})`);
    } else {
        // Actualizar Ãºltima interacciÃ³n
        cliente.ultima_interaccion = new Date().toISOString();
        
        // Actualizar nombre si cambiÃ³
        if (cliente.nombre !== nombre) {
            console.log(`ğŸ‘¤ Nombre actualizado: ${cliente.nombre} â†’ ${nombre}`);
            cliente.nombre = nombre;
        }
    }
    
    fs.writeFileSync('./data/clientes.json', JSON.stringify(clientesData, null, 2));
}

// ğŸ“Š Obtener informaciÃ³n del cliente
function obtenerInfoCliente(telefono) {
    const clientesData = JSON.parse(fs.readFileSync('./data/clientes.json', 'utf8'));
    return clientesData.clientes.find(c => c.telefono === telefono);
}

// ğŸ” FunciÃ³n para verificar si el mensaje es sobre negocio
function verificarMensajeNegocio(texto) {
    const textoLimpio = texto.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    
    const tienePalabraNegocio = palabrasClave.palabras_negocio.some(palabra => {
        const palabraLimpia = palabra.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        return textoLimpio.includes(palabraLimpia);
    });
    
    const tienePalabraProducto = palabrasClave.palabras_productos.some(palabra => {
        const palabraLimpia = palabra.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        return textoLimpio.includes(palabraLimpia);
    });
    
    const tieneSaludoContextual = palabrasClave.saludos_contextuales.some(saludo => {
        const saludoLimpio = saludo.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        return textoLimpio.includes(saludoLimpio);
    });
    
    return tienePalabraNegocio || tienePalabraProducto || tieneSaludoContextual;
}

// ğŸ›’ Procesar mensajes
async function procesarMensaje(textoLower, textoOriginal, from, nombreContacto) {
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ“Š HISTORIAL Y ESTADÃSTICAS DEL CLIENTE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Ver mis pedidos / historial
    if (textoLower.match(/mis pedidos|mi historial|historial|pedidos anteriores|ultimos pedidos/)) {
        return mostrarHistorialCliente(from);
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ”” CONTROL DE NOTIFICACIONES (Solo dueÃ±o)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Verificar si el mensaje es del dueÃ±o
    if (from === negocioData.numero_dueÃ±o) {
    
        // Activar notificaciones
        if (textoLower.match(/activar notificaciones|notificaciones on|encender notificaciones/)) {
            negocioData.notificaciones_activas = true;
            fs.writeFileSync('./data/negocio.json', JSON.stringify(negocioData, null, 2));
            return `âœ… *Notificaciones ACTIVADAS*\n\n` +
                   `RecibirÃ¡s un mensaje automÃ¡tico cada vez que un cliente confirme un pedido.\n\n` +
                   `Para desactivar: "desactivar notificaciones"`;
        }
    
        // Desactivar notificaciones
        if (textoLower.match(/desactivar notificaciones|notificaciones off|apagar notificaciones/)) {
            negocioData.notificaciones_activas = false;
            fs.writeFileSync('./data/negocio.json', JSON.stringify(negocioData, null, 2));
            return `ğŸ”• *Notificaciones DESACTIVADAS*\n\n` +
                   `Ya no recibirÃ¡s mensajes automÃ¡ticos de nuevos pedidos.\n\n` +
                   `Para activar: "activar notificaciones"`;
        }
    
        // Ver estado de notificaciones
        if (textoLower.match(/estado notificaciones|ver notificaciones|notificaciones estado/)) {
            const estado = negocioData.notificaciones_activas ? 'âœ… ACTIVADAS' : 'ğŸ”• DESACTIVADAS';
            const emoji = negocioData.notificaciones_activas ? 'ğŸ””' : 'ğŸ”•';
        
            let respuesta = `${emoji} *Estado de Notificaciones*\n\n`;
            respuesta += `Estado actual: ${estado}\n\n`;
        
            if (negocioData.notificaciones_activas) {
                respuesta += `RecibirÃ¡s notificaciones de:\n`;
                respuesta += `â€¢ Nuevos pedidos confirmados\n`;
                respuesta += `â€¢ Detalles del cliente\n`;
                respuesta += `â€¢ Productos solicitados\n`;
                respuesta += `â€¢ Total del pedido\n\n`;
                respuesta += `Para desactivar: "desactivar notificaciones"`;
            } else {
                respuesta += `No recibirÃ¡s notificaciones automÃ¡ticas.\n\n`;
                respuesta += `Para activar: "activar notificaciones"`;
            }
        
            return respuesta;
        }
    
        // EstadÃ­sticas rÃ¡pidas (bonus)
        if (textoLower.match(/estadisticas|stats|resumen/)) {
            const clientesData = JSON.parse(fs.readFileSync('./data/clientes.json', 'utf8'));
            const pedidosData = JSON.parse(fs.readFileSync('./data/pedidos.json', 'utf8'));
        
            let respuesta = `ğŸ“Š *ESTADÃSTICAS DEL NEGOCIO*\n\n`;
            respuesta += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
            respuesta += `ğŸ‘¥ Total clientes: ${clientesData.estadisticas.total_clientes}\n`;
            respuesta += `ğŸ“¦ Total pedidos: ${clientesData.estadisticas.total_pedidos}\n`;
            respuesta += `ğŸ’° Total vendido: $${clientesData.estadisticas.total_vendido}\n`;
            respuesta += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
        
            // Ãšltimo pedido
            if (pedidosData.pedidos.length > 0) {
                const ultimoPedido = pedidosData.pedidos[pedidosData.pedidos.length - 1];
                respuesta += `ğŸ“„ *Ãšltimo pedido:*\n`;
                respuesta += `â€¢ ${ultimoPedido.id} - ${ultimoPedido.nombre}\n`;
                respuesta += `â€¢ $${ultimoPedido.total} - ${formatearFecha(ultimoPedido.fecha)}\n\n`;
            }
        
            respuesta += `ğŸ’¡ Comandos disponibles:\n`;
            respuesta += `â€¢ "activar notificaciones"\n`;
            respuesta += `â€¢ "desactivar notificaciones"\n`;
            respuesta += `â€¢ "estado notificaciones"`;
        
            return respuesta;
        }
    }

    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ›’ SISTEMA DE PEDIDOS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Ver carrito
    if (textoLower.match(/ver carrito|mi carrito|carrito|mi pedido/)) {
        marcarSesionActiva(from, 'consulta_carrito');
        return mostrarCarrito(from);
    }
    
    // Confirmar pedido
    if (textoLower.match(/^(confirmar|confirmo|si confirmo|ok confirmo)$/)) {
        return confirmarPedido(from, nombreContacto);
    }
    
    // Cancelar/vaciar carrito
    if (textoLower.match(/cancelar|vaciar|borrar carrito|limpiar carrito/)) {
        limpiarSesion(from);
        return cancelarCarrito(from);
    }
    
    // Quitar producto del carrito
    if (textoLower.match(/quitar|eliminar|sacar/)) {
        const numero = extraerNumero(textoOriginal);
        if (numero) {
            marcarSesionActiva(from, 'modificando_carrito');
            return quitarProductoCarrito(from, numero - 1);
        }
    }
    
    // Manejar "si" para agregar al carrito
    if (textoLower.match(/^(si|sÃ­|ok|dale|confirmo si)$/)) {
        if (carritos[from] && carritos[from].temporal && carritos[from].temporal.length > 0) {
            marcarSesionActiva(from, 'pedido');
            return agregarAlCarrito(from);
        }
    }
    
    // Manejar "no"
    if (textoLower.match(/^(no|nope|cancel)$/)) {
        if (carritos[from] && carritos[from].temporal && carritos[from].temporal.length > 0) {
            carritos[from].temporal = [];
            limpiarSesion(from);
            return `âŒ Pedido cancelado.\n\nPuedes hacer otro pedido cuando quieras.`;
        }
    }
    
    // Manejar opciones de entrega (1 o 2)
    if (textoLower.match(/^[12]$/)) {
        const respuestaEntrega = procesarOpcionEntrega(from, textoLower, nombreContacto);
        if (respuestaEntrega) {
            limpiarSesion(from); // Limpiar sesiÃ³n despuÃ©s de confirmar pedido
            return respuestaEntrega;
        }
    }
    
    // Detectar intento de pedido con texto libre
    const productosDetectados = detectarProductosEnTexto(textoOriginal);
    
    if (productosDetectados.length > 0) {
        marcarSesionActiva(from, 'seleccionando_productos');
        return procesarDeteccionProductos(from, productosDetectados);
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ“‹ CONSULTAS NORMALES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Saludos
    if (textoLower.match(/hola|buenas|buenos dias|buenas tardes|buenas noches|hey|hi/)) {
        const infoCliente = obtenerInfoCliente(from);
        let saludo = `Â¡Hola`;
        
        if (infoCliente && infoCliente.total_pedidos > 0) {
            saludo += ` de nuevo`;
        }
        
        saludo += `! ğŸ‘‹ Bienvenido a *${negocioData.nombre}*\n\n`;
        
        if (infoCliente && infoCliente.total_pedidos > 0) {
            saludo += `ğŸ“Š Has realizado ${infoCliente.total_pedidos} pedido(s) con nosotros ğŸ‰\n\n`;
        }
        
        saludo += `Te puedo ayudar con:\n` +
               `ğŸ“‹ Lista de precios\n` +
               `ğŸ• Horarios\n` +
               `ğŸ“ UbicaciÃ³n\n` +
               `ğŸ“¦ Stock de productos\n` +
               `ğŸ›’ Hacer un pedido\n` +
               `ğŸ’³ Medios de pago\n`;
        
        if (infoCliente && infoCliente.total_pedidos > 0) {
            saludo += `ğŸ“œ Ver mis pedidos anteriores\n`;
        }
        
        saludo += `\nÂ¿QuÃ© necesitas?`;
        
        marcarSesionActiva(from, 'consulta');
        return saludo;
    }

    // Horarios
    if (textoLower.match(/horario|hora|atencion|abren|cierran|abierto/)) {
        marcarSesionActiva(from, 'consulta');
        return `ğŸ• *Horarios de AtenciÃ³n*\n\n${negocioData.horarios}`;
    }

    // UbicaciÃ³n
    if (textoLower.match(/ubicacion|direccion|donde|local|negocio|como llego/)) {
        marcarSesionActiva(from, 'consulta');
        return `ğŸ“ *Nuestra UbicaciÃ³n*\n\n${negocioData.direccion}\n\nTe esperamos! ğŸ˜Š`;
    }

    // Precios - LibrerÃ­a
    if (textoLower.match(/cuaderno|lapiz|lapicera|marcador|libreria|escolar|boligrafo/)) {
        marcarSesionActiva(from, 'consulta_productos');
        return buscarPreciosCategoria('libreria');
    }

    // Precios - CotillÃ³n
    if (textoLower.match(/cotillon|globo|vela|cumpleaÃ±os|cumpleanos|fiesta|piÃ±ata|pinata|decoracion/)) {
        marcarSesionActiva(from, 'consulta_productos');
        return buscarPreciosCategoria('cotillon');
    }

    // Precios - JugueterÃ­a
    if (textoLower.match(/juguete|rompecabeza|bloque|didactico|juego/)) {
        marcarSesionActiva(from, 'consulta_productos');
        return buscarPreciosCategoria('jugueteria');
    }

    // Impresiones
    if (textoLower.match(/fotocopia|impresi|imprim|sublim|remera|taza|edicion|diseÃ±o|diseno/)) {
        marcarSesionActiva(from, 'consulta_productos');
        return buscarPreciosCategoria('impresiones') + 
               `\n\nğŸ’¡ *Servicios disponibles:*\n` +
               `- Fotocopias B/N y Color\n` +
               `- SublimaciÃ³n en remeras\n` +
               `- Tazas personalizadas\n` +
               `- Mousepads custom\n` +
               `- DiseÃ±o e impresiÃ³n de invitaciones\n\n` +
               `Para hacer un pedido, escribe por ejemplo:\n` +
               `"Quiero 2 remeras" o "Necesito 5 tazas"`;
    }

    // Bijou
    if (textoLower.match(/bijou|aro|collar|pulsera|accesorio|joya|anillo/)) {
        marcarSesionActiva(from, 'consulta_productos');
        return buscarPreciosCategoria('bijou');
    }

    // Accesorios celular
    if (textoLower.match(/celular|funda|vidrio|cargador|auricula|telefono|movil|cable/)) {
        marcarSesionActiva(from, 'consulta_productos');
        return buscarPreciosCategoria('accesorios_celular');
    }

    // Accesorios computadora
    if (textoLower.match(/computadora|mouse|teclado|pendrive|webcam|pc|compu|usb/)) {
        marcarSesionActiva(from, 'consulta_productos');
        return buscarPreciosCategoria('accesorios_computadora');
    }

    // Stock
    if (textoLower.match(/stock|hay|tienen|disponible|queda|quedan/)) {
        marcarSesionActiva(from, 'consulta');
        return `ğŸ“¦ Para consultar stock especÃ­fico, escribe el nombre del producto.\n\n` +
               `Ejemplo: "Hay cuadernos A4?"`;
    }

    // Lista completa
    if (textoLower.match(/lista|precio|catalogo|que tienen|que venden|productos|menu/)) {
        marcarSesionActiva(from, 'consulta');
        return `ğŸ“‹ *CategorÃ­as Disponibles:*\n\n` +
               `ğŸ“š LibrerÃ­a\n` +
               `ğŸ‰ CotillÃ³n\n` +
               `ğŸ§¸ JugueterÃ­a\n` +
               `ğŸ“„ Fotocopiadora\n` +
               `ğŸ–¨ï¸ Impresiones personalizadas\n` +
               `ğŸ’ Bijou\n` +
               `ğŸ“± Accesorios celular\n` +
               `ğŸ’» Accesorios computadora\n\n` +
               `Para hacer un pedido, escribe por ejemplo:\n` +
               `"Quiero 2 cuadernos y 5 lapiceras"`;
    }

    // Pago
    if (textoLower.match(/pago|efectivo|tarjeta|transfer|mercadopago|debito|credito/)) {
        marcarSesionActiva(from, 'consulta');
        return `ğŸ’³ *Medios de Pago:*\n\n${negocioData.medios_pago}`;
    }

    // Contacto
    if (textoLower.match(/contacto|telefono|whatsapp|llamar/)) {
        marcarSesionActiva(from, 'consulta');
        return `ğŸ“ *Contacto*\n\n` +
               `WhatsApp: ${negocioData.whatsapp}\n` +
               `TelÃ©fono: ${negocioData.telefono}\n\n` +
               `Â¡Estamos para ayudarte! ğŸ˜Š`;
    }

    // Respuesta por defecto
    return `No entendÃ­ bien tu consulta ğŸ¤”\n\n` +
           `Puedes preguntarme sobre:\n` +
           `â€¢ Precios y productos\n` +
           `â€¢ Hacer un pedido (ej: "Quiero 2 cuadernos")\n` +
           `â€¢ Ver mis pedidos anteriores\n` +
           `â€¢ Horarios de atenciÃ³n\n` +
           `â€¢ UbicaciÃ³n del local\n` +
           `â€¢ Stock disponible\n` +
           `â€¢ Medios de pago\n\n` +
           `Â¿En quÃ© te puedo ayudar?`;
}

// ğŸ“œ Mostrar historial del cliente
function mostrarHistorialCliente(telefono) {
    const infoCliente = obtenerInfoCliente(telefono);
    
    if (!infoCliente || infoCliente.total_pedidos === 0) {
        return `ğŸ“œ *Tu Historial*\n\n` +
               `AÃºn no has realizado pedidos con nosotros.\n\n` +
               `Â¿Te gustarÃ­a hacer tu primer pedido? ğŸ›’\n` +
               `Escribe por ejemplo: "Quiero 2 cuadernos"`;
    }
    
    let respuesta = `ğŸ“œ *TU HISTORIAL DE PEDIDOS*\n`;
    respuesta += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
    respuesta += `ğŸ‘¤ Cliente: ${infoCliente.nombre}\n`;
    respuesta += `ğŸ“± TelÃ©fono: ${infoCliente.telefono.replace('@c.us', '')}\n`;
    respuesta += `ğŸ“… Cliente desde: ${formatearFecha(infoCliente.fecha_registro)}\n`;
    respuesta += `ğŸ“¦ Total de pedidos: ${infoCliente.total_pedidos}\n`;
    respuesta += `ğŸ’° Total gastado: $${infoCliente.total_gastado}\n\n`;
    respuesta += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
    
    if (infoCliente.pedidos.length > 0) {
        respuesta += `ğŸ“‹ *ÃšLTIMOS PEDIDOS:*\n\n`;
        
        // Mostrar Ãºltimos 5 pedidos
        const ultimosPedidos = infoCliente.pedidos.slice(-5).reverse();
        
        ultimosPedidos.forEach((pedido, index) => {
            respuesta += `${index + 1}. *${pedido.id}* - ${formatearFecha(pedido.fecha)}\n`;
            respuesta += `   ğŸ’° Total: $${pedido.total}\n`;
            respuesta += `   ğŸ“¦ Productos:\n`;
            
            pedido.productos.slice(0, 3).forEach(prod => {
                respuesta += `      â€¢ ${prod.nombre} x${prod.cantidad}\n`;
            });
            
            if (pedido.productos.length > 3) {
                respuesta += `      â€¢ ... y ${pedido.productos.length - 3} mÃ¡s\n`;
            }
            
            respuesta += `   ğŸšš Entrega: ${pedido.tipo_entrega === 'delivery' ? 'Delivery' : 'Retiro'}\n`;
            respuesta += `   âœ… Estado: ${pedido.estado}\n\n`;
        });
        
        if (infoCliente.pedidos.length > 5) {
            respuesta += `... y ${infoCliente.pedidos.length - 5} pedidos mÃ¡s\n\n`;
        }
    }
    
    respuesta += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    respuesta += `ğŸ™ Â¡Gracias por tu preferencia!\n\n`;
    respuesta += `Â¿Deseas hacer un nuevo pedido? ğŸ›’`;
    
    return respuesta;
}

// ğŸ“… Formatear fecha
function formatearFecha(isoString) {
    const fecha = new Date(isoString);
    const dia = String(fecha.getDate()).padStart(2, '0');
    const mes = String(fecha.getMonth() + 1).padStart(2, '0');
    const aÃ±o = fecha.getFullYear();
    const hora = String(fecha.getHours()).padStart(2, '0');
    const minutos = String(fecha.getMinutes()).padStart(2, '0');
    
    return `${dia}/${mes}/${aÃ±o} ${hora}:${minutos}`;
}

// ğŸ” Detectar productos en el texto
function detectarProductosEnTexto(texto) {
    const productosDetectados = [];
    const textoLower = texto.toLowerCase();
    
    // Convertir palabras numÃ©ricas a nÃºmeros
    const numerosTexto = {
        'un': 1, 'una': 1, 'uno': 1,
        'dos': 2, 'tres': 3, 'cuatro': 4, 'cinco': 5,
        'seis': 6, 'siete': 7, 'ocho': 8, 'nueve': 9, 'diez': 10
    };
    
    // Buscar en todas las categorÃ­as
    for (const [categoria, subcategorias] of Object.entries(listaPrecios)) {
        for (const [subcategoria, productos] of Object.entries(subcategorias)) {
            for (const [nombreProducto, infoProducto] of Object.entries(productos)) {
                
                // Normalizar nombre del producto
                const nombreNormalizado = nombreProducto.replace(/_/g, ' ').toLowerCase();
                const palabrasProducto = nombreNormalizado.split(' ');
                
                // Buscar si el texto menciona este producto
                const mencionaProducto = palabrasProducto.some(palabra => 
                    textoLower.includes(palabra) && palabra.length > 3
                );
                
                if (mencionaProducto) {
                    // Buscar cantidad cerca del nombre del producto
                    let cantidad = 1; // Por defecto 1
                    
                    // Buscar nÃºmeros antes o despuÃ©s del producto
                    const regexNumero = /(\d+|un|una|uno|dos|tres|cuatro|cinco|seis|siete|ocho|nueve|diez)/gi;
                    const matches = texto.match(regexNumero);
                    
                    if (matches) {
                        const ultimoMatch = matches[matches.length - 1].toLowerCase();
                        cantidad = numerosTexto[ultimoMatch] || parseInt(ultimoMatch) || 1;
                    }
                    
                    productosDetectados.push({
                        nombre: nombreProducto,
                        nombreFormateado: nombreProducto.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                        cantidad: cantidad,
                        precio: infoProducto.precio || infoProducto.precio_desde,
                        stock: infoProducto.stock,
                        categoria: categoria
                    });
                    
                    break; // Solo el primer match por producto
                }
            }
        }
    }
    
    return productosDetectados;
}

// ğŸ›’ Procesar productos detectados
function procesarDeteccionProductos(from, productos) {
    if (productos.length === 0) {
        return `ğŸ¤” No encontrÃ© productos especÃ­ficos en tu mensaje.\n\n` +
               `Intenta escribir algo como:\n` +
               `"Quiero 2 cuadernos A4"\n` +
               `"Dame 5 lapiceras"\n` +
               `"Necesito 3 globos"`;
    }
    
    let respuesta = `ğŸ” *EncontrÃ© estos productos:*\n\n`;
    
    productos.forEach((prod, index) => {
        const numero = index + 1;
        const stockEmoji = prod.stock ? 'âœ…' : 'âŒ';
        const precioTotal = prod.precio * prod.cantidad;
        
        respuesta += `${numero}ï¸âƒ£ ${stockEmoji} ${prod.nombreFormateado}\n`;
        respuesta += `   Cantidad: ${prod.cantidad}\n`;
        respuesta += `   Precio unitario: $${prod.precio}\n`;
        respuesta += `   Subtotal: $${precioTotal}\n\n`;
    });
    
    // Verificar si alguno no tiene stock
    const sinStock = productos.filter(p => !p.stock);
    if (sinStock.length > 0) {
        respuesta += `âš ï¸ ATENCIÃ“N: Algunos productos estÃ¡n SIN STOCK\n\n`;
    }
    
    respuesta += `Â¿Es correcto este pedido?\n\n`;
    respuesta += `â€¢ Escribe *"si"* para agregarlo al carrito\n`;
    respuesta += `â€¢ Escribe *"no"* para cancelar\n`;
    respuesta += `â€¢ Escribe *"cambiar [nÃºmero]"* para modificar cantidad`;
    
    // Guardar productos detectados temporalmente
    if (!carritos[from]) {
        carritos[from] = { productos: [], temporal: [] };
    }
    carritos[from].temporal = productos;
    
    return respuesta;
}

// âœ… Agregar productos al carrito (cuando dice "si")
function agregarAlCarrito(from) {
    if (!carritos[from] || !carritos[from].temporal || carritos[from].temporal.length === 0) {
        return `âŒ No hay productos pendientes para agregar.\n\n` +
               `Escribe tu pedido, ejemplo: "Quiero 2 cuadernos"`;
    }
    
    const productosTemporales = carritos[from].temporal;
    
    // Verificar stock
    const sinStock = productosTemporales.filter(p => !p.stock);
    if (sinStock.length > 0) {
        let respuesta = `âŒ No puedo agregar estos productos porque estÃ¡n SIN STOCK:\n\n`;
        sinStock.forEach(p => {
            respuesta += `â€¢ ${p.nombreFormateado}\n`;
        });
        respuesta += `\nÂ¿Deseas continuar solo con los productos disponibles? (si/no)`;
        return respuesta;
    }
    
    // Inicializar carrito si no existe
    if (!carritos[from].productos) {
        carritos[from].productos = [];
    }
    
    // Agregar productos
    productosTemporales.forEach(prod => {
        carritos[from].productos.push(prod);
    });
    
    // Limpiar temporal
    carritos[from].temporal = [];
    
    // Iniciar timer de expiraciÃ³n (15 minutos)
    iniciarTimerCarrito(from);
    
    return mostrarCarrito(from) + 
           `\n\nğŸ’¡ Â¿Deseas agregar mÃ¡s productos?\n` +
           `â€¢ Escribe otro pedido (ej: "3 lapiceras")\n` +
           `â€¢ O escribe *"confirmar"* para finalizar`;
}

// ğŸ“Š Mostrar carrito
function mostrarCarrito(from) {
    if (!carritos[from] || !carritos[from].productos || carritos[from].productos.length === 0) {
        return `ğŸ›’ Tu carrito estÃ¡ vacÃ­o\n\n` +
               `Para hacer un pedido, escribe por ejemplo:\n` +
               `"Quiero 2 cuadernos" o "Dame 5 lapiceras"`;
    }
    
    let respuesta = `ğŸ›’ *TU CARRITO*\n`;
    respuesta += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
    
    let total = 0;
    
    carritos[from].productos.forEach((prod, index) => {
        const numero = index + 1;
        const subtotal = prod.precio * prod.cantidad;
        total += subtotal;
        
        respuesta += `${numero}. ${prod.nombreFormateado}\n`;
        respuesta += `   ${prod.cantidad} x $${prod.precio} = $${subtotal}\n\n`;
    });
    
    // Calcular descuento
    let descuento = 0;
    let mensajeDescuento = '';
    
    if (configPedidos.descuentos.habilitado) {
        for (const regla of configPedidos.descuentos.reglas) {
            if (total >= regla.minimo) {
                descuento = Math.floor(total * (regla.porcentaje / 100));
                mensajeDescuento = `ğŸ‰ ${regla.descripcion}\n`;
            }
        }
    }
    
    respuesta += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    respuesta += `ğŸ’° Subtotal: $${total}\n`;
    
    if (descuento > 0) {
        respuesta += mensajeDescuento;
        respuesta += `ğŸ Descuento: -$${descuento}\n`;
        respuesta += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
        respuesta += `ğŸ’° *TOTAL: $${total - descuento}*\n`;
    } else {
        respuesta += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
        respuesta += `ğŸ’° *TOTAL: $${total}*\n`;
    }
    
    respuesta += `\nğŸ“ Opciones:\n`;
    respuesta += `â€¢ *"confirmar"* - Finalizar pedido\n`;
    respuesta += `â€¢ *"quitar [nÃºmero]"* - Eliminar producto\n`;
    respuesta += `â€¢ *"cancelar"* - Vaciar carrito\n`;
    
    // Mostrar tiempo restante
    if (timersCarrito[from]) {
        respuesta += `\nâ° Tu carrito expira en 15 minutos`;
    }
    
    return respuesta;
}

// âœ… Confirmar pedido
function confirmarPedido(from, nombreContacto) {
    if (!carritos[from] || !carritos[from].productos || carritos[from].productos.length === 0) {
        return `âŒ No tienes productos en el carrito.\n\n` +
               `Para hacer un pedido, escribe por ejemplo:\n` +
               `"Quiero 2 cuadernos"`;
    }
    
    const productos = carritos[from].productos;
    let total = 0;
    
    productos.forEach(prod => {
        total += prod.precio * prod.cantidad;
    });
    
    // Calcular descuento
    let descuento = 0;
    let porcentajeDescuento = 0;
    
    if (configPedidos.descuentos.habilitado) {
        for (const regla of configPedidos.descuentos.reglas) {
            if (total >= regla.minimo) {
                descuento = Math.floor(total * (regla.porcentaje / 100));
                porcentajeDescuento = regla.porcentaje;
            }
        }
    }
    
    const subtotal = total;
    const totalFinal = total - descuento;
    
    // Opciones de entrega
    let respuesta = `ğŸ“‹ *RESUMEN DE TU PEDIDO*\n`;
    respuesta += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
    
    productos.forEach((prod, index) => {
        const numero = index + 1;
        const subtotalProd = prod.precio * prod.cantidad;
        respuesta += `${numero}. ${prod.nombreFormateado} x${prod.cantidad}\n`;
        respuesta += `   $${subtotalProd}\n\n`;
    });
    
    respuesta += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    respuesta += `ğŸ’° Subtotal: $${subtotal}\n`;
    
    if (descuento > 0) {
        respuesta += `ğŸ Descuento (${porcentajeDescuento}%): -$${descuento}\n`;
    }
    
    respuesta += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    respuesta += `ğŸ’° *TOTAL: $${totalFinal}*\n\n`;
    
    // Opciones de entrega
    if (configPedidos.delivery.habilitado) {
        respuesta += `ğŸšš *Â¿CÃ³mo lo querÃ©s recibir?*\n\n`;
        respuesta += `1ï¸âƒ£ *Retiro en local* (Gratis)\n`;
        respuesta += `   ğŸ“ ${negocioData.direccion}\n`;
        respuesta += `   ğŸ• ${negocioData.horarios}\n\n`;
        
        if (configPedidos.delivery.gratis_desde && totalFinal >= configPedidos.delivery.gratis_desde) {
            respuesta += `2ï¸âƒ£ *Delivery* (GRATIS por tu compra)\n\n`;
        } else {
            respuesta += `2ï¸âƒ£ *Delivery* (+$${configPedidos.delivery.costo})\n\n`;
        }
        
        respuesta += `Responde *"1"* o *"2"* para continuar`;
        
        // Guardar estado esperando entrega
        carritos[from].esperandoEntrega = true;
        carritos[from].totalFinal = totalFinal;
        carritos[from].descuento = descuento;
        
        marcarSesionActiva(from, 'confirmando_pedido');
        
    } else {
        // Solo retiro
        respuesta += `ğŸ“ *Retiro en local*\n`;
        respuesta += `${negocioData.direccion}\n`;
        respuesta += `ğŸ• ${negocioData.horarios}\n\n`;
        
        respuesta += `ğŸ’³ *Medios de pago:*\n`;
        respuesta += `${negocioData.medios_pago}\n\n`;
        
        // Guardar pedido y actualizar cliente
        const numeroPedido = guardarPedidoYActualizarCliente(from, nombreContacto, productos, subtotal, descuento, totalFinal, 'retiro', 0);
        
        respuesta += `âœ… *PEDIDO CONFIRMADO*\n`;
        respuesta += `ğŸ“„ NÃºmero de pedido: *#${numeroPedido}*\n\n`;
        respuesta += `ğŸ™ Â¡Gracias por tu compra!`;
        
        // Limpiar carrito y sesiÃ³n
        delete carritos[from];
        clearTimeout(timersCarrito[from]);
        delete timersCarrito[from];
        limpiarSesion(from);
    }
    
    return respuesta;
}

// ğŸšš Procesar opciÃ³n de entrega
function procesarOpcionEntrega(from, opcion, nombreContacto) {
    if (!carritos[from] || !carritos[from].esperandoEntrega) {
        return null; // No estÃ¡ esperando opciÃ³n de entrega
    }
    
    const productos = carritos[from].productos;
    const totalFinal = carritos[from].totalFinal;
    const descuento = carritos[from].descuento;
    const subtotal = totalFinal + descuento;
    
    let tipoEntrega = '';
    let costoDelivery = 0;
    let respuesta = '';
    
    if (opcion === '1') {
        // Retiro en local
        tipoEntrega = 'retiro';
        
        respuesta += `âœ… *PEDIDO CONFIRMADO*\n`;
        respuesta += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
        respuesta += `ğŸª *Retiro en local*\n`;
        respuesta += `ğŸ“ ${negocioData.direccion}\n`;
        respuesta += `ğŸ• ${negocioData.horarios}\n\n`;
        
    } else if (opcion === '2') {
        // Delivery
        tipoEntrega = 'delivery';
        
        // Verificar si delivery es gratis
        if (configPedidos.delivery.gratis_desde && totalFinal >= configPedidos.delivery.gratis_desde) {
            costoDelivery = 0;
        } else {
            costoDelivery = configPedidos.delivery.costo;
        }
        
        respuesta += `âœ… *PEDIDO CONFIRMADO*\n`;
        respuesta += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
        respuesta += `ğŸšš *Delivery*\n`;
        
        if (costoDelivery > 0) {
            respuesta += `Costo de envÃ­o: $${costoDelivery}\n`;
        } else {
            respuesta += `ğŸ‰ EnvÃ­o GRATIS por tu compra\n`;
        }
        respuesta += `\n`;
        
    } else {
        return `âŒ OpciÃ³n no vÃ¡lida.\n\nResponde *"1"* para retiro o *"2"* para delivery`;
    }
    
    // Resumen de productos
    productos.forEach((prod, index) => {
        const numero = index + 1;
        respuesta += `${numero}. ${prod.nombreFormateado} x${prod.cantidad} - $${prod.precio * prod.cantidad}\n`;
    });
    
    respuesta += `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    respuesta += `ğŸ’° Subtotal: $${subtotal}\n`;
    
    if (descuento > 0) {
        respuesta += `ğŸ Descuento: -$${descuento}\n`;
    }
    
    if (costoDelivery > 0) {
        respuesta += `ğŸšš Delivery: +$${costoDelivery}\n`;
    }
    
    const totalConDelivery = totalFinal + costoDelivery;
    
    respuesta += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    respuesta += `ğŸ’° *TOTAL: $${totalConDelivery}*\n\n`;
    
    respuesta += `ğŸ’³ *Medios de pago:*\n`;
    respuesta += `${negocioData.medios_pago}\n\n`;
    
    // Guardar pedido y actualizar cliente
    const numeroPedido = guardarPedidoYActualizarCliente(from, nombreContacto, productos, subtotal, descuento, totalConDelivery, tipoEntrega, costoDelivery);
    
    respuesta += `ğŸ“„ NÃºmero de pedido: *#${numeroPedido}*\n\n`;
    respuesta += `ğŸ™ Â¡Gracias por tu compra!\n`;
    respuesta += `Te contactaremos pronto para coordinar.`;
    
    // Limpiar carrito
    delete carritos[from];
    clearTimeout(timersCarrito[from]);
    delete timersCarrito[from];
    
    return respuesta;
}

// ğŸ’¾ Guardar pedido, actualizar cliente y NOTIFICAR AL DUEÃ‘O
async function guardarPedidoYActualizarCliente(from, nombreContacto, productos, subtotal, descuento, total, tipoEntrega, costoDelivery) {
    // 1. Guardar en pedidos.json
    const dataPedidos = JSON.parse(fs.readFileSync('./data/pedidos.json', 'utf8'));
    
    dataPedidos.ultimo_numero += 1;
    const numeroPedido = `PED-${String(dataPedidos.ultimo_numero).padStart(3, '0')}`;
    
    const pedido = {
        id: numeroPedido,
        cliente: from,
        nombre: nombreContacto,
        fecha: new Date().toISOString(),
        productos: productos.map(p => ({
            nombre: p.nombreFormateado,
            cantidad: p.cantidad,
            precio_unitario: p.precio,
            subtotal: p.precio * p.cantidad
        })),
        subtotal: subtotal,
        descuento: descuento,
        delivery: costoDelivery,
        total: total,
        tipo_entrega: tipoEntrega,
        estado: 'confirmado'
    };
    
    dataPedidos.pedidos.push(pedido);
    fs.writeFileSync('./data/pedidos.json', JSON.stringify(dataPedidos, null, 2));
    
    // 2. Actualizar informaciÃ³n del cliente
    const clientesData = JSON.parse(fs.readFileSync('./data/clientes.json', 'utf8'));
    
    let cliente = clientesData.clientes.find(c => c.telefono === from);
    
    if (!cliente) {
        cliente = {
            telefono: from,
            nombre: nombreContacto,
            fecha_registro: new Date().toISOString(),
            ultima_interaccion: new Date().toISOString(),
            total_pedidos: 0,
            total_gastado: 0,
            pedidos: []
        };
        clientesData.clientes.push(cliente);
    }
    
    cliente.total_pedidos += 1;
    cliente.total_gastado += total;
    cliente.ultima_interaccion = new Date().toISOString();
    cliente.pedidos.push(pedido);
    
    clientesData.estadisticas.total_pedidos += 1;
    clientesData.estadisticas.total_vendido += total;
    
    fs.writeFileSync('./data/clientes.json', JSON.stringify(clientesData, null, 2));
    
    console.log(`ğŸ’¾ Pedido guardado: ${numeroPedido} - $${total} - ${nombreContacto}`);
    console.log(`ğŸ‘¤ Cliente actualizado: ${cliente.nombre} - Total: ${cliente.total_pedidos} pedidos - $${cliente.total_gastado}`);
    
    // 3. ğŸ”” NOTIFICAR AL DUEÃ‘O
    await notificarNuevoPedido(pedido, from, nombreContacto);
    
    return numeroPedido;
}

// ğŸ”” Enviar notificaciÃ³n al dueÃ±o del negocio
// ğŸ”” Enviar notificaciÃ³n al dueÃ±o del negocio
async function notificarNuevoPedido(pedido, telefonoCliente, nombreCliente) {
    try {
        // Verificar si las notificaciones estÃ¡n activas
        if (!negocioData.notificaciones_activas) {
            console.log(`ğŸ”• Notificaciones desactivadas. No se enviÃ³ notificaciÃ³n.`);
            return;
        }
        
        // Formatear telÃ©fono del cliente para WhatsApp link
        const telefonoLimpio = telefonoCliente.replace('@c.us', '');
        const whatsappLink = `https://wa.me/${telefonoLimpio}`;
        
        // Construir mensaje de notificaciÃ³n
        let mensaje = `ğŸ”” *NUEVO PEDIDO RECIBIDO*\n\n`;
        mensaje += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
        mensaje += `ğŸ“„ *Pedido:* ${pedido.id}\n`;
        mensaje += `ğŸ‘¤ *Cliente:* ${nombreCliente}\n`;
        mensaje += `ğŸ“± *TelÃ©fono:* ${telefonoLimpio}\n`;
        mensaje += `ğŸ“… *Fecha:* ${formatearFecha(pedido.fecha)}\n`;
        mensaje += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
        
        mensaje += `ğŸ“¦ *PRODUCTOS:*\n`;
        pedido.productos.forEach((prod, index) => {
            mensaje += `${index + 1}. ${prod.nombre} x${prod.cantidad}\n`;
            mensaje += `   $${prod.precio_unitario} c/u = $${prod.subtotal}\n`;
        });
        
        mensaje += `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
        mensaje += `ğŸ’° *Subtotal:* $${pedido.subtotal}\n`;
        
        if (pedido.descuento > 0) {
            const porcentaje = Math.round((pedido.descuento / pedido.subtotal) * 100);
            mensaje += `ğŸ *Descuento (${porcentaje}%):* -$${pedido.descuento}\n`;
        }
        
        if (pedido.delivery > 0) {
            mensaje += `ğŸšš *Delivery:* +$${pedido.delivery}\n`;
        }
        
        mensaje += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
        mensaje += `ğŸ’° *TOTAL:* $${pedido.total}\n\n`;
        
        mensaje += `ğŸšš *Entrega:* ${pedido.tipo_entrega === 'delivery' ? 'Delivery' : 'Retiro en local'}\n`;
        mensaje += `ğŸ’³ *Estado de pago:* Pendiente\n`;
        mensaje += `âœ… *Estado:* ${pedido.estado}\n\n`;
        
        mensaje += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
        mensaje += `ğŸ“² *Para contactar al cliente:*\n`;
        mensaje += `${whatsappLink}\n\n`;
        mensaje += `ğŸ’¡ _Responde desde tu WhatsApp para coordinar._`;
        
        let notificacionEnviada = false;
        
        // OPCIÃ“N 1: Enviar al grupo de notificaciones (si existe y es vÃ¡lido)
        if (negocioData.grupo_notificaciones && 
            negocioData.grupo_notificaciones.trim() !== '' &&
            negocioData.grupo_notificaciones.includes('@g.us')) {
            
            try {
                await client.sendMessage(negocioData.grupo_notificaciones, mensaje);
                console.log(`âœ… NotificaciÃ³n enviada al grupo: ${pedido.id}`);
                notificacionEnviada = true;
            } catch (errorGrupo) {
                console.error(`âŒ Error al enviar al grupo:`, errorGrupo.message);
                console.log(`âš ï¸ Intentando enviar a dueÃ±os individuales...`);
            }
        }
        
        // OPCIÃ“N 2: Si no hay grupo o fallÃ³, enviar a cada dueÃ±o individualmente
        if (!notificacionEnviada) {
            const dueÃ±os = negocioData.numeros_dueÃ±os || 
                          (negocioData.numero_dueÃ±o ? [negocioData.numero_dueÃ±o] : []);
            
            if (dueÃ±os.length === 0) {
                console.log(`âš ï¸ No hay nÃºmeros de dueÃ±os configurados. No se puede enviar notificaciÃ³n.`);
                return;
            }
            
            for (const numeroDueÃ±o of dueÃ±os) {
                if (!numeroDueÃ±o || numeroDueÃ±o.trim() === '') continue;
                
                try {
                    await client.sendMessage(numeroDueÃ±o, mensaje);
                    console.log(`âœ… NotificaciÃ³n enviada a: ${numeroDueÃ±o} - Pedido: ${pedido.id}`);
                    notificacionEnviada = true;
                } catch (errorIndividual) {
                    console.error(`âŒ Error al notificar a ${numeroDueÃ±o}:`, errorIndividual.message);
                }
            }
        }
        
        if (!notificacionEnviada) {
            console.log(`âš ï¸ No se pudo enviar notificaciÃ³n por ningÃºn medio.`);
        }
        
    } catch (error) {
        console.error(`âŒ Error al enviar notificaciÃ³n:`, error.message);
    }
}
        
        if (!notificacionEnviada) {
            console.log(`âš ï¸ No se pudo enviar notificaciÃ³n por ningÃºn medio.`);
        }
        
    } catch (error) {
        console.error(`âŒ Error al enviar notificaciÃ³n:`, error.message);
    }
}        
        // Verificar que exista el nÃºmero del dueÃ±o
        if (!negocioData.numero_dueÃ±o) {
            console.log(`âš ï¸ No hay nÃºmero de dueÃ±o configurado. No se puede enviar notificaciÃ³n.`);
            return;
        }
        
        // Formatear telÃ©fono del cliente para WhatsApp link
        const telefonoLimpio = telefonoCliente.replace('@c.us', '');
        const whatsappLink = `https://wa.me/${telefonoLimpio}`;
        
        // Construir mensaje de notificaciÃ³n
        let mensaje = `ğŸ”” *NUEVO PEDIDO RECIBIDO*\n\n`;
        mensaje += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
        mensaje += `ğŸ“„ *Pedido:* ${pedido.id}\n`;
        mensaje += `ğŸ‘¤ *Cliente:* ${nombreCliente}\n`;
        mensaje += `ğŸ“± *TelÃ©fono:* ${telefonoLimpio}\n`;
        mensaje += `ğŸ“… *Fecha:* ${formatearFecha(pedido.fecha)}\n`;
        mensaje += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
        
        mensaje += `ğŸ“¦ *PRODUCTOS:*\n`;
        pedido.productos.forEach((prod, index) => {
            mensaje += `${index + 1}. ${prod.nombre} x${prod.cantidad}\n`;
            mensaje += `   $${prod.precio_unitario} c/u = $${prod.subtotal}\n`;
        });
        
        mensaje += `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
        mensaje += `ğŸ’° *Subtotal:* $${pedido.subtotal}\n`;
        
        if (pedido.descuento > 0) {
            const porcentaje = Math.round((pedido.descuento / pedido.subtotal) * 100);
            mensaje += `ğŸ *Descuento (${porcentaje}%):* -$${pedido.descuento}\n`;
        }
        
        if (pedido.delivery > 0) {
            mensaje += `ğŸšš *Delivery:* +$${pedido.delivery}\n`;
        }
        
        mensaje += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
        mensaje += `ğŸ’° *TOTAL:* $${pedido.total}\n\n`;
        
        mensaje += `ğŸšš *Entrega:* ${pedido.tipo_entrega === 'delivery' ? 'Delivery' : 'Retiro en local'}\n`;
        mensaje += `ğŸ’³ *Estado de pago:* Pendiente\n`;
        mensaje += `âœ… *Estado:* ${pedido.estado}\n\n`;
        
        mensaje += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
        mensaje += `ğŸ“² *Para contactar al cliente:*\n`;
        mensaje += `${whatsappLink}\n\n`;
        mensaje += `ğŸ’¡ _Responde desde tu WhatsApp para coordinar._`;
        
        // Enviar mensaje al dueÃ±o
        await client.sendMessage(negocioData.numero_dueÃ±o, mensaje);
        
        console.log(`âœ… NotificaciÃ³n enviada al dueÃ±o: ${pedido.id}`);
        
    } catch (error) {
        console.error(`âŒ Error al enviar notificaciÃ³n al dueÃ±o:`, error);
    }
}

// ğŸ—‘ï¸ Cancelar/vaciar carrito
function cancelarCarrito(from) {
    if (!carritos[from] || !carritos[from].productos || carritos[from].productos.length === 0) {
        return `ğŸ›’ Tu carrito ya estÃ¡ vacÃ­o`;
    }
    
    delete carritos[from];
    clearTimeout(timersCarrito[from]);
    delete timersCarrito[from];
    
    return `âœ… Carrito vaciado correctamente\n\n` +
           `Para hacer un nuevo pedido, escribe por ejemplo:\n` +
           `"Quiero 2 cuadernos"`;
}

// ğŸ—‘ï¸ Quitar producto del carrito
function quitarProductoCarrito(from, index) {
    if (!carritos[from] || !carritos[from].productos || carritos[from].productos.length === 0) {
        return `ğŸ›’ Tu carrito estÃ¡ vacÃ­o`;
    }
    
    if (index < 0 || index >= carritos[from].productos.length) {
        return `âŒ NÃºmero de producto invÃ¡lido\n\n` + mostrarCarrito(from);
    }
    
    const productoEliminado = carritos[from].productos.splice(index, 1)[0];
    
    let respuesta = `âœ… Eliminado: ${productoEliminado.nombreFormateado} x${productoEliminado.cantidad}\n\n`;
    
    if (carritos[from].productos.length === 0) {
        delete carritos[from];
        clearTimeout(timersCarrito[from]);
        delete timersCarrito[from];
        respuesta += `ğŸ›’ Tu carrito estÃ¡ vacÃ­o`;
    } else {
        respuesta += mostrarCarrito(from);
    }
    
    return respuesta;
}

// â° Iniciar timer de expiraciÃ³n del carrito
function iniciarTimerCarrito(from) {
    if (timersCarrito[from]) {
        clearTimeout(timersCarrito[from]);
    }
    
    timersCarrito[from] = setTimeout(() => {
        if (carritos[from]) {
            delete carritos[from];
            delete timersCarrito[from];
            console.log(`â° Carrito expirado para: ${from}`);
        }
    }, configPedidos.carrito.expiracion_minutos * 60 * 1000);
}

// ğŸ”¢ Extraer nÃºmero de un texto
function extraerNumero(texto) {
    const match = texto.match(/\d+/);
    return match ? parseInt(match[0]) : null;
}

// ğŸ’° Buscar precios por categorÃ­a
function buscarPreciosCategoria(categoria) {
    const datos = listaPrecios[categoria];
    let respuesta = `ğŸ’° *Precios - ${categoria.toUpperCase().replace(/_/g, ' ')}*\n\n`;
    
    let contador = 0;
    for (const [subcategoria, productos] of Object.entries(datos)) {
        for (const [nombre, info] of Object.entries(productos)) {
            const stockEmoji = info.stock ? 'âœ…' : 'âŒ';
            const precioTexto = info.precio_desde 
                ? `desde $${info.precio_desde}` 
                : `$${info.precio}${info.unidad ? ' ' + info.unidad : ''}`;
            
            const nombreFormateado = nombre.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            respuesta += `${stockEmoji} ${nombreFormateado}: ${precioTexto}\n`;
            contador++;
        }
    }
    
    if (contador === 0) {
        respuesta += `No encontrÃ© productos en esta categorÃ­a.\n`;
    }
    
    respuesta += `\nğŸ’¡ Para hacer un pedido, escribe por ejemplo:\n`;
    respuesta += `"Quiero 2 cuadernos" o "Necesito 5 lapiceras"`;
    
    return respuesta;
}

client.initialize();